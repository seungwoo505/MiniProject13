<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Cloud Storage 테스트 - 공유 기능</title>
  <!-- 부트스트랩 CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h1>파일 목록</h1>
    <ul id="fileList" class="list-group mb-4"></ul>
    
    <!-- 공유 기능 영역 (파일을 클릭하면 해당 파일의 공유 기능이 나타납니다.) -->
    <div id="shareInterface" style="display: none;">
      <h2>파일 공유</h2>
      <p id="fileNameDisplay"></p>
      <div class="form-group">
        <label for="shareEmail">공유할 사용자 이메일:</label>
        <input type="email" id="shareEmail" class="form-control" placeholder="user@example.com">
      </div>
      <button id="shareBtn" class="btn btn-primary">공유하기</button>
      <h4 class="mt-3">현재 공유 대상 목록</h4>
      <ul id="shareList" class="list-group"></ul>
      <button id="backToListBtn" class="btn btn-secondary mt-3">목록으로 돌아가기</button>
    </div>
  </div>

  <script>
    // 전역 변수: 현재 선택한 파일의 id와 이름 저장
    let currentFileId = null;
    let currentFileName = '';

    // 파일 목록을 불러오는 함수
    function fetchFiles() {
      axios.post('http://localhost:8080/getFiles', {userId : "이승우"})
        .then(response => {
          const files = response.data;
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';

          files.forEach(file => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = file.fileName + ' (' + file.userId + ')';
            li.style.cursor = 'pointer';
            li.addEventListener('click', () => {
              // 상세정보 조회 없이 파일 목록에 있는 데이터로 공유 기능 화면 표시
              currentFileId = file.fileId;
              currentFileName = file.fileName;
              showShareInterface();
            });
            fileList.appendChild(li);
          });
        })
        .catch(error => {
          console.error('파일 목록 로드 실패:', error.data.msg);
        });
    }

    // 공유 기능 인터페이스를 표시하는 함수
    function showShareInterface() {
      document.getElementById('fileList').style.display = 'none';
      document.getElementById('shareInterface').style.display = 'block';
      document.getElementById('fileNameDisplay').innerText = '파일 이름: ' + currentFileName;

      // 접근 유형이 USER_SPECIFIC인 경우에만 공유 인터페이스가 활성화 되도록 할 수도 있음
      // 여기서는 모든 파일에 대해 공유 기능을 테스트한다고 가정합니다.
      loadShareList(currentFileId);
      document.getElementById('shareEmail').value = '';
    }

    // 공유 대상 목록을 불러오는 함수
    function loadShareList(fileId) {
      axios.post('http://localhost:8080/share/shareFile', {fileId})
        .then(response => {
          const shares = response.data;
          const shareList = document.getElementById('shareList');
          shareList.innerHTML = '';
          shares.forEach(share => {
            console.log(share);
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = share;
            shareList.appendChild(li);
          });
        })
        .catch(error => {
          console.error('공유 대상 목록 로드 실패:', error);
        });
    }

    // 파일을 특정 사용자에게 공유하는 함수
    function shareFile() {
      const shareId = document.getElementById('shareEmail').value.trim();
      if (!shareId) {
        alert('공유할 이메일을 입력하세요.');
        return;
      }
      axios.post('http://localhost:8080/share/create', { userId : "이승우", fileId : currentFileId, shareId, shareUser : true })
        .then(response => {
          console.log(response.data);
          alert(`공유 성공! : ${response.data}`);
          loadShareList(currentFileId);
          document.getElementById('shareEmail').value = '';
        })
        .catch(error => {
          alert('공유에 실패했습니다.');
          console.error('공유 실패:', error);
        });
    }

    // "목록으로 돌아가기" 버튼 이벤트
    document.getElementById('backToListBtn').addEventListener('click', () => {
      document.getElementById('shareInterface').style.display = 'none';
      document.getElementById('fileList').style.display = 'block';
      fetchFiles();
    });

    // 공유 버튼 클릭 이벤트 등록
    document.getElementById('shareBtn').addEventListener('click', shareFile);

    // 페이지 로드 시 파일 목록 로드
    fetchFiles();
  </script>
</body>
</html>